name: Bump Version

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - minor
          - major

permissions:
  contents: write

jobs:
  bump:
    name: Bump ${{ github.event.inputs.bump_type }} version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Get latest tag
        id: latest_tag
        run: |
          git fetch --tags
          TAG=$(git tag --sort=-v:refname | head -1)
          echo "tag=${TAG:-v0.0.0}" >> "$GITHUB_OUTPUT"

      - name: Bump version
        id: bump
        run: |
          TAG="${{ steps.latest_tag.outputs.tag }}"
          VERSION="${TAG#v}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)

          if [ "${{ github.event.inputs.bump_type }}" = "major" ]; then
            NEW_TAG="v$((MAJOR + 1)).0.0"
          else
            NEW_TAG="v${MAJOR}.$((MINOR + 1)).0"
          fi

          echo "new_tag=${NEW_TAG}" >> "$GITHUB_OUTPUT"

      - name: Create and push tag
        run: |
          git tag "${{ steps.bump.outputs.new_tag }}"
          git push origin "${{ steps.bump.outputs.new_tag }}"

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
